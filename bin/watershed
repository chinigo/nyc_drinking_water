#!/usr/bin/env python
import os
import pdb
import re

from grass_session import Session
from grass.script import core as gscript

data_dir = './data'

def input_files():
    return [os.path.join(data_dir, f) for f in os.listdir(data_dir)]

def renamed_dem(original_path):
    return re.sub(r'ASTGTM2_(.*)_dem.tif', '\\1', os.path.basename(original_path))

def imported_files():
    return [i[0] for i in gscript.list_pairs('raster', pattern='N*W*')]


with Session(gisdb="grass_session", location="location", create_opts="EPSG:2260"):
    gscript.run_command('g.remove', type='raster', pattern='*', flags='f')

    # Copy input DEMs and re-project to EPSG:2260
    for input_dem in input_files():
        gscript.run_command('r.import',
                input     = input_dem,
                output    = renamed_dem(input_dem),
                overwrite = True,
                verbose   = True)

    # Update viewport to the concatenation of all those input DEMs
    gscript.run_command('g.region', flags='p', raster=','.join(imported_files()))

    # Concatenate all those input DEMs
    gscript.run_command('r.patch',
            verbose=True,
            input=','.join(imported_files()),
            output='patched',
            overwrite=True)

    # Calculate relief map hillshade
    gscript.run_command('r.relief',
            input='patched',
            output='relief',
            zscale='2',
            overwrite=True)

    # Calculate watersheds
    gscript.run_command('r.watershed',
            elevation='patched',
            threshold=1000,     # cell units
            drainage='drainage',
            basin='basin',
            stream='stream',
            flags='b',          # Multi-stream, 8 directions, beautify flat areas
            verbose=True,
            overwrite=True
            )

    # Vectorize basin outlines from watershed raster
    gscript.run_command('r.to.vect',
            input='basin',
            out='basin_v',
            flags='v',     # Remember raster value as vector category (so colors line up)
            type='area',
            overwrite=True)

    # Simplify & vectorize streams
    gscript.run_command('r.thin',
            input='stream',
            output='stream_thinned',
            overwrite=True)

    gscript.run_command('r.to.vect',
            input='stream_thinned',
            output='stream_v',
            type='line',
          overwrite=True)

    gscript.run_command('r.water.outlet',
            input='drainage',
            output='rondout',
            coordinates='513063.086,1082204.467',
            verbose=True,
            overwrite=True)

    gscript.run_command('r.to.vect',
            input='rondout',
            output='roundout_v',
            type='area',
            overwrite=True)
